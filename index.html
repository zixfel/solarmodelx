<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√≠nh To√°n Ti·∫øt Ki·ªám ƒêi·ªán M·∫∑t Tr·ªùi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(30, 40, 60, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2em;
            color: #4ade80;
            margin-bottom: 10px;
        }

        .header-subtitle {
            color: #a0aec0;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .storage-info {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid #8b5cf6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .storage-info strong {
            color: #c4b5fd;
        }

        .evn-calculator-btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1em;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .evn-calculator-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .evn-calculator-btn:active {
            transform: translateY(0);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #4ade80;
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.2);
        }

        .card h3 {
            font-size: 0.7em;
            color: #a0aec0;
            margin-bottom: 6px;
            line-height: 1.2;
        }

        .card .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #4ade80;
            line-height: 1.2;
        }

        .input-section {
            background: rgba(45, 55, 72, 0.6);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .input-section h2 {
            margin-bottom: 15px;
            color: #4ade80;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .collapsible-content.expanded {
            max-height: 5000px;
            opacity: 1;
        }

        .price-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .investment-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(124, 58, 237, 0.15) 100%);
            border: 2px solid #8b5cf6;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
        }

        .investment-section h2 {
            color: #c4b5fd;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .investment-config {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .investment-input-wrapper {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .investment-input-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd);
        }

        .investment-input-wrapper label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e7ff;
            font-size: 1.05em;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .investment-input-wrapper label::before {
            content: 'üí∞';
            font-size: 1.3em;
        }

        .investment-input-wrapper input[type="text"] {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.4em;
            border: 2px solid rgba(139, 92, 246, 0.4);
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.8);
            color: #fff;
            font-weight: 800;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);\n        }

        .investment-input-wrapper input[type="text"]:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2), inset 0 2px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .investment-input-wrapper .tooltip {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 15px;
            font-size: 0.85em;
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            border-left: 3px solid #8b5cf6;
        }

        .investment-input-wrapper .tooltip::before {
            content: 'üí°';
            font-size: 1.2em;
        }



        .roi-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 2px solid rgba(124, 58, 237, 0.3);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.15);
            backdrop-filter: blur(10px);
        }

        .roi-section h2 {
            color: #e0e7ff;
            margin-bottom: 30px;
            font-size: 1.6em;
            text-align: center;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }

        .roi-section .investment-config {
            margin-bottom: 30px;
        }

        .roi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .roi-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(139, 92, 246, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .roi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd);
        }

        .roi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .roi-card h4 {
            color: #a78bfa;
            font-size: 0.7em;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .roi-card .roi-value {
            font-size: 1.4em;
            font-weight: 800;
            color: #fff;
            background: linear-gradient(135deg, #f3f4f6, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .roi-card .roi-unit {
            font-size: 0.85em;
            color: #94a3b8;
            margin-top: 8px;
            font-weight: 500;
        }

        .roi-progress {
            margin-top: 20px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 15px;
            border: 2px solid rgba(139, 92, 246, 0.2);
        }

        .roi-progress-label {
            color: #e0e7ff;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .roi-progress-percentage {
            color: #c4b5fd;
            font-size: 1.3em;
            font-weight: 800;
        }

        .roi-progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .roi-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: 800;
            font-size: 0.9em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .roi-progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        /* Responsive: Gi·∫£m s·ªë c·ªôt tr√™n m√†n h√¨nh nh·ªè h∆°n */
        @media (max-width: 1800px) {
            .input-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1400px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .pagination-info {
            color: #cbd5e0;
            font-size: 0.9em;
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 6px;
        }

        .month-input {
            background: rgba(26, 32, 44, 0.8);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #4a5568;
        }

        .month-input h4 {
            margin-bottom: 5px;
            color: #4ade80;
            font-size: 0.8em;
            font-weight: 600;
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-size: 0.65em;
            color: #cbd5e0;
            font-weight: 500;
        }

        input[type="number"] {
            width: 100%;
            padding: 6px;
            margin-bottom: 5px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #2d3748;
            color: #fff;
            font-size: 0.8em;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #4ade80;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }

        /* Remove spinner for number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn-calculate {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #1a202c;
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 222, 128, 0.4);
        }

        .btn-save {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-load {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-load:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-demo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-demo:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-add-month {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-add-month:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-remove-month {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .btn-remove-month:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(249, 115, 22, 0.4);
        }

        .month-count-info {
            text-align: center;
            padding: 10px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            margin-bottom: 15px;
            color: #c4b5fd;
            font-weight: bold;
        }

        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-import {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            cursor: pointer;
            display: inline-block;
        }

        .btn-import:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.4);
        }

        .chart-container {
            background: rgba(45, 55, 72, 0.6);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            height: 500px;
        }

        .month-details {
            background: rgba(45, 55, 72, 0.6);
            padding: 25px;
            border-radius: 15px;
        }

        .month-details h2 {
            color: #4ade80;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .details-grid {
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
        }

        .details-grid.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .details-grid.expanded {
            max-height: 10000px;
            opacity: 1;
        }

        .details-rows-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .details-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        @media (max-width: 1400px) {
            .details-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .details-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .details-row {
                grid-template-columns: 1fr;
            }
        }

        .detail-card {
            background: rgba(26, 32, 44, 0.9);
            padding: 8px;
            border-radius: 8px;
            border-left: 3px solid #4ade80;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            font-size: 0.75em;
        }

        /* Xanh l√° - H√†ng ch·∫µn (2, 4, 6, 8, 10, 12) */
        .detail-card:nth-child(2n) {
            background: rgba(34, 197, 94, 0.15);
            border-left: 3px solid #4ade80;
        }

        /* Xanh d∆∞∆°ng - H√†ng l·∫ª (1, 3, 5, 7, 9, 11) */
        .detail-card:nth-child(2n+1) {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #60a5fa;
        }

        .detail-card h4 {
            color: #4ade80;
            margin-bottom: 6px;
            font-size: 0.95em;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 4px;
            font-weight: bold;
        }

        /* Title m√†u xanh d∆∞∆°ng cho h√†ng l·∫ª */
        .detail-card:nth-child(2n+1) h4 {
            color: #60a5fa;
        }

        .detail-row-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(74, 85, 104, 0.5);
            font-size: 0.95em;
        }

        .detail-row-item:last-child {
            border-bottom: none;
        }

        .detail-row-item.highlight {
            font-weight: bold;
            color: #4ade80;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 2px solid #4ade80;
        }

        /* Highlight xanh d∆∞∆°ng cho card l·∫ª */
        .detail-card:nth-child(2n+1) .detail-row-item.highlight {
            color: #60a5fa;
            border-top-color: #60a5fa;
        }

        .detail-row-item.section-header {
            color: #f59e0b;
            font-weight: bold;
            margin-top: 6px;
            border-bottom: 2px solid #f59e0b;
            padding-bottom: 3px;
        }

        .detail-row-item.grid-cost {
            color: #ef4444;
        }

        .detail-row-item .label {
            color: #cbd5e0;
            font-size: 0.9em;
        }

        .detail-row-item .value {
            color: #fff;
            font-weight: 500;
        }

        .tooltip {
            font-size: 0.75em;
            color: #a0aec0;
            font-style: italic;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #1a202c;
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .auto-save-indicator {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(74, 222, 128, 0.2);
            border-radius: 5px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .auto-save-indicator.active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Mobile-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Touch device optimizations */
            button {
                min-height: 44px; /* iOS minimum touch target */
            }

            input[type="number"],
            input[type="text"] {
                min-height: 44px; /* iOS minimum touch target */
            }

            .toggle-btn {
                min-height: 44px;
            }
            
            /* Button group compact on mobile - 3x3 grid */
            .button-group button {
                min-height: 44px;
                padding: 10px 4px;
                font-size: 0.7em;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Better touch scrolling on iOS */
        .collapsible-content,
        .details-grid {
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.4em;
                line-height: 1.3;
                text-align: center;
            }

            .header-subtitle {
                font-size: 0.9em;
                line-height: 1.5;
                text-align: center;
            }

            .auto-save-indicator {
                font-size: 0.8em;
                padding: 6px 10px;
            }

            .storage-info {
                padding: 12px 15px;
                font-size: 0.85em;
                margin-bottom: 15px;
                text-align: center;
            }

            /* Summary cards - 3 c·ªôt tr√™n mobile, si√™u compact */
            .summary-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .card {
                padding: 10px 8px;
                border-left: 2px solid #4ade80;
            }

            .card h3 {
                font-size: 0.65em;
                margin-bottom: 5px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                line-height: 1.1;
            }

            .card .value {
                font-size: 1em;
                font-weight: 800;
            }

            /* Investment section */
            .investment-section {
                padding: 15px;
            }

            .investment-section h2 {
                font-size: 1.2em;
            }

            .investment-input-wrapper {
                padding: 15px;
            }

            .investment-input-wrapper label {
                font-size: 0.9em;
            }

            .investment-input-wrapper input[type="text"] {
                padding: 12px;
                font-size: 1.1em;
            }

            .config-note {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }

            .note-icon {
                font-size: 1.3em;
            }

            .note-content strong {
                font-size: 1em;
            }

            .note-content ul li {
                font-size: 0.65em;
                line-height: 1.5;
            }

            /* ROI Section */
            .roi-section {
                padding: 20px 15px;
            }

            .roi-section h2 {
                font-size: 1.3em;
                flex-direction: column;
                gap: 8px;
            }

            .roi-section .investment-config {
                margin-bottom: 20px;
            }

            .investment-input-wrapper {
                padding: 18px;
            }

            .investment-input-wrapper label {
                font-size: 0.9em;
            }

            .investment-input-wrapper input[type="text"] {
                font-size: 1.3em;
                padding: 15px;
            }

            .roi-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .roi-card {
                padding: 10px 8px;
            }

            .roi-card h4 {
                font-size: 0.65em;
                line-height: 1.1;
            }

            .roi-card .roi-value {
                font-size: 0.95em;
            }

            .roi-progress {
                padding: 15px;
            }

            .roi-progress-label {
                font-size: 0.9em;
            }

            .roi-progress-percentage {
                font-size: 1.2em;
            }

            .roi-progress-bar {
                height: 25px;
            }

            /* Input section */
            .input-section {
                padding: 15px;
            }

            .input-section h2 {
                font-size: 1.2em;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .input-section h2 span {
                text-align: center;
            }

            .toggle-btn {
                padding: 10px 15px;
                font-size: 0.9em;
                width: 100%;
            }

            /* Month inputs - 3 c·ªôt tr√™n mobile, si√™u compact */
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .month-input {
                padding: 6px;
                border-left: 2px solid #8b5cf6;
            }

            .month-input h4 {
                font-size: 0.75em;
                margin-bottom: 4px;
                font-weight: 700;
            }

            .month-input label {
                font-size: 0.6em;
                margin-bottom: 2px;
                font-weight: 600;
                display: block;
            }

            .month-input input[type="number"] {
                padding: 6px 4px;
                font-size: 0.8em;
                margin-bottom: 4px;
                font-weight: 600;
                width: 100%;
            }

            /* Buttons - 3 c·ªôt 3 h√†ng, compact */
            .button-group {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            button {
                width: 100%;
                padding: 10px 8px;
                font-size: 0.7em;
                font-weight: 600;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .pagination {
                gap: 8px;
            }

            .pagination button {
                padding: 10px 15px;
                font-size: 0.9em;
            }

            .pagination-info {
                font-size: 0.85em;
                padding: 8px 12px;
            }

            .month-count-info {
                font-size: 0.9em;
                padding: 10px 15px;
            }

            /* Chart - Cao h∆°n tr√™n mobile */
            .chart-container {
                height: 350px;
                margin-bottom: 20px;
            }

            /* Month details - 1 c·ªôt, border tr√°i */
            .month-details h2 {
                font-size: 1.2em;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .month-details h2 span {
                text-align: center;
            }

            .details-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .detail-card {
                padding: 10px;
                font-size: 0.75em;
                border-left: 2px solid #4ade80;
            }

            .detail-card h4 {
                font-size: 0.85em;
                font-weight: 700;
                margin-bottom: 6px;
            }

            .detail-row-item {
                padding: 5px 0;
                font-size: 0.8em;
            }

            .detail-row-item .label {
                font-weight: 600;
            }

            .detail-row-item .value {
                font-weight: 700;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            /* Storage info */
            .storage-info {
                padding: 12px;
                font-size: 0.85em;
            }
        }

        /* Extra small screens (< 400px) */
        @media (max-width: 400px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.1em;
            }

            .summary-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .card {
                padding: 8px 6px;
            }

            .card h3 {
                font-size: 0.6em;
            }

            .card .value {
                font-size: 0.9em;
            }

            .input-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .month-input {
                padding: 6px;
            }

            .month-input h4 {
                font-size: 0.75em;
            }

            .month-input label {
                font-size: 0.6em;
            }

            .month-input input[type="number"] {
                padding: 6px 4px;
                font-size: 0.8em;
            }

            .roi-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .roi-card {
                padding: 8px 6px;
            }

            .details-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .detail-card {
                padding: 8px 6px;
            }

            .month-input input[type="number"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }

            .investment-input-wrapper input[type="text"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        /* Tablet (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .roi-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .details-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .roi-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .details-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåû T√≠nh To√°n Ti·∫øt Ki·ªám ƒêi·ªán NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</h1>
            <div class="header-subtitle">
                Qu·∫£n l√Ω v√† theo d√µi hi·ªáu qu·∫£ ti·∫øt ki·ªám t·ª´ h·ªá th·ªëng nƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi c·ªßa b·∫°n<br>
                <span class="auto-save-indicator" id="autoSaveIndicator">üíæ L∆∞u t·ª± ƒë·ªông khi b·∫•m L∆∞u C√†i ƒê·∫∑t</span>
            </div>
            <a href="TEST-TIERED-PRICING.html" class="evn-calculator-btn" target="_blank">
                ‚ö° T√≠nh Ti·ªÅn ƒêi·ªán EVN (B·∫≠c Thang)
            </a>
        </div>

        <div class="storage-info" id="storageInfo">
            <strong>üíæ Tr·∫°ng th√°i l∆∞u tr·ªØ:</strong> <span id="storageStatus">ƒêang t·∫£i...</span>
        </div>

        <div class="summary-cards">
            <div class="card">
                <h3>T·ªïng Ti·∫øt Ki·ªám</h3>
                <div class="value" id="totalSavings">0 ‚Ç´</div>
            </div>
            <div class="card">
                <h3>T·ªïng ƒêi·ªán Ti√™u Th·ª•<br>(Load)</h3>
                <div class="value" id="totalLoad">0 kWh</div>
            </div>
            <div class="card">
                <h3>T·ªïng ƒêi·ªán Solar<br>S·∫£n Xu·∫•t</h3>
                <div class="value" id="totalSolar">0 kWh</div>
            </div>
            <div class="card">
                <h3>T·ªïng ƒêi·ªán L∆∞·ªõi<br>EVN (Grid)</h3>
                <div class="value" id="totalGrid">0 kWh</div>
            </div>
            <div class="card">
                <h3>Chi Ph√≠ N·∫øu<br>Kh√¥ng C√≥ Solar</h3>
                <div class="value" id="totalCostWithoutSolar">0 ‚Ç´</div>
            </div>
            <div class="card">
                <h3>Trung B√¨nh<br>Ti·∫øt Ki·ªám/Th√°ng</h3>
                <div class="value" id="avgSavings">0 ‚Ç´</div>
            </div>
            <div class="card">
                <h3>Trung B√¨nh<br>T·ªïng ƒêi·ªán Ti√™u Th·ª•</h3>
                <div class="value" id="avgLoad">0 kWh</div>
            </div>
            <div class="card">
                <h3>Trung B√¨nh<br>ƒêi·ªán Solar S·∫£n Xu·∫•t</h3>
                <div class="value" id="avgSolar">0 kWh</div>
            </div>
            <div class="card">
                <h3>Trung B√¨nh<br>ƒêi·ªán L∆∞·ªõi EVN</h3>
                <div class="value" id="avgGrid">0 kWh</div>
            </div>
            <div class="card">
                <h3>Trung B√¨nh<br>Kh√¥ng C√≥ Solar/Th√°ng</h3>
                <div class="value" id="avgCostWithoutSolar">0 ‚Ç´</div>
            </div>
        </div>

        <!-- Hidden inputs for backward compatibility -->
        <input type="hidden" id="solarPrice" value="0">
        <input type="hidden" id="vatRate" value="8">

        <div class="roi-section" id="roiSection">
            <h2>üí∞ ƒê·∫ßu T∆∞ & Ph√¢n T√≠ch Ho√†n V·ªën (ROI)</h2>
            
            <!-- Investment Input -->
            <div class="investment-config">
                <div class="investment-input-wrapper">
                    <label>Chi ph√≠ l·∫Øp ƒë·∫∑t h·ªá th·ªëng (VNƒê)</label>
                    <input type="text" id="initialCost" value="0" placeholder="V√≠ d·ª•: 150,000,000">
                    <span class="tooltip">Nh·∫≠p t·ªïng chi ph√≠ ƒë·∫ßu t∆∞ ban ƒë·∫ßu ƒë·ªÉ t√≠nh to√°n ROI (ho√†n v·ªën)</span>
                </div>
            </div>

            <!-- ROI Cards -->
            <div class="roi-cards">
                <div class="roi-card">
                    <h4>üíµ Chi Ph√≠ L·∫Øp ƒê·∫∑t</h4>
                    <div class="roi-value" id="roiInitialCost">0 ‚Ç´</div>
                </div>
                <div class="roi-card">
                    <h4>üí∞ ƒê√£ Ti·∫øt Ki·ªám</h4>
                    <div class="roi-value" id="roiSaved">0 ‚Ç´</div>
                    <div class="roi-unit" id="roiSavedNote"></div>
                </div>
                <div class="roi-card">
                    <h4>üìâ C√≤n Ph·∫£i Thu H·ªìi</h4>
                    <div class="roi-value" id="roiRemaining">0 ‚Ç´</div>
                    <div class="roi-unit" id="roiRemainingNote"></div>
                </div>
                <div class="roi-card" id="roiProfitCard" style="display: none;">
                    <h4>üí∏ Ti·ªÅn L·ªùi (Sau Ho√†n V·ªën)</h4>
                    <div class="roi-value" id="roiProfit" style="color: #10b981;">0 ‚Ç´</div>
                    <div class="roi-unit" id="roiProfitNote"></div>
                </div>
                <div class="roi-card">
                    <h4>‚è±Ô∏è Th·ªùi Gian Ho√†n V·ªën</h4>
                    <div class="roi-value" id="roiTime">0 th√°ng</div>
                    <div class="roi-unit" id="roiTimeNote"></div>
                </div>
            </div>
            <div class="roi-progress">
                <div class="roi-progress-label">
                    <span>üìä Ti·∫øn ƒê·ªô Ho√†n V·ªën</span>
                    <span class="roi-progress-percentage" id="roiProgressText">0%</span>
                </div>
                <div class="roi-progress-bar">
                    <div class="roi-progress-fill" id="roiProgressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h2>
                <span>üìä Nh·∫≠p D·ªØ Li·ªáu (12 Th√°ng)</span>
                <button class="toggle-btn" onclick="toggleMonthInputs()" id="toggleBtn">üîº ·∫®n</button>
            </h2>
            <div class="collapsible-content expanded" id="monthInputsContainer">
                <div class="month-count-info" id="monthCountInfo">üìÖ Hi·ªán c√≥ 12 th√°ng</div>
                <div class="pagination" id="paginationTop">
                    <button onclick="previousPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="pageInfo">Trang 1</span>
                    <button onclick="nextPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
                <div class="input-grid" id="monthInputs"></div>
                <div class="pagination" id="paginationBottom">
                    <button onclick="previousPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="pageInfoBottom">Trang 1</span>
                    <button onclick="nextPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-calculate" onclick="calculateSavings()">üîç T√≠nh</button>
                <button class="btn-add-month" onclick="addMonth()" title="Th√™m th√°ng m·ªõi (t·ª± ƒë·ªông ƒëi·ªÅn demo data, c√≥ th·ªÉ ch·ªânh s·ª≠a)">‚ûï Th√™m</button>
                <button class="btn-remove-month" onclick="removeMonth()">‚ûñ X√≥a</button>
                <button class="btn-demo" onclick="loadDemoData()" title="T·∫£i demo data cho T·∫§T C·∫¢ th√°ng hi·ªán t·∫°i (t·ª± ƒë·ªông tƒÉng 3%/nƒÉm)">üéØ Demo</button>
                <button class="btn-save" onclick="saveSettings()">üíæ L∆∞u</button>
                <button class="btn-load" onclick="loadSettings()">üìÇ T·∫£i</button>
                <button class="btn-export" onclick="exportSettings()">üì§ Xu·∫•t</button>
                <button class="btn-import" onclick="document.getElementById('importFile').click()">üì• Nh·∫≠p</button>
                <input type="file" id="importFile" accept=".json" onchange="importSettings(event)" style="display: none;">
                <button class="btn-reset" onclick="resetData()">üîÑ Reset</button>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="savingsChart"></canvas>
        </div>

        <div class="month-details">
            <h2>
                <span>üìã Chi Ti·∫øt T·ª´ng Th√°ng</span>
                <button class="toggle-btn" onclick="toggleMonthDetails()" id="toggleDetailsBtn">üîº ·∫®n</button>
            </h2>
            <div class="details-grid expanded" id="monthDetailsContainer">
                <div class="month-count-info" id="detailsMonthCountInfo">üìÖ Hi·ªán c√≥ 12 th√°ng</div>
                <div class="pagination" id="detailsPaginationTop">
                    <button onclick="previousDetailsPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="detailsPageInfo">Trang 1</span>
                    <button onclick="nextDetailsPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
                <div id="monthDetails">
                    <!-- Chi ti·∫øt s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JavaScript -->
                </div>
                <div class="pagination" id="detailsPaginationBottom">
                    <button onclick="previousDetailsPage()">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="pagination-info" id="detailsPageInfoBottom">Trang 1</span>
                    <button onclick="nextDetailsPage()">Sau ‚ñ∂Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let autoSaveTimeout = null;
        let totalMonths = 12; // S·ªë th√°ng hi·ªán t·∫°i, c√≥ th·ªÉ thay ƒë·ªïi
        let startYear = new Date().getFullYear(); // NƒÉm b·∫Øt ƒë·∫ßu
        
        // Pagination for input
        let currentPage = 1;
        const MONTHS_PER_PAGE = 12; // Hi·ªÉn th·ªã 12 th√°ng m·ªói trang
        
        // Pagination for details
        let currentDetailsPage = 1;
        const DETAILS_MONTHS_PER_PAGE = 24; // Hi·ªÉn th·ªã 24 th√°ng m·ªói trang (2 nƒÉm)
        let allMonthlyDetails = []; // L∆∞u t·∫•t c·∫£ chi ti·∫øt th√°ng

        // T·∫°o t√™n th√°ng ƒë·ªông
        function getMonthName(index) {
            const monthInYear = (index % 12) + 1;
            const year = startYear + Math.floor(index / 12);
            return `Th√°ng ${monthInYear}/${year}`;
        }

        // L·∫•y danh s√°ch t√™n th√°ng cho bi·ªÉu ƒë·ªì
        function getMonthNames() {
            const names = [];
            for (let i = 0; i < totalMonths; i++) {
                names.push(getMonthName(i));
            }
            return names;
        }

        // Format s·ªë ti·ªÅn v·ªõi d·∫•u ph·∫©y
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // X√≥a d·∫•u ph·∫©y kh·ªèi s·ªë
        function unformatNumber(str) {
            return str.replace(/,/g, '');
        }

        // X·ª≠ l√Ω input chi ph√≠ l·∫Øp ƒë·∫∑t
        function setupInitialCostInput() {
            const input = document.getElementById('initialCost');
            
            // Khi ng∆∞·ªùi d√πng nh·∫≠p
            input.addEventListener('input', function(e) {
                let value = unformatNumber(e.target.value);
                
                // Ch·ªâ cho ph√©p s·ªë
                value = value.replace(/[^0-9]/g, '');
                
                // Format v·ªõi d·∫•u ph·∫©y
                if (value) {
                    e.target.value = formatNumber(value);
                } else {
                    e.target.value = '';
                }
            });
            
            // Khi focus v√†o (x√≥a 0 n·∫øu c√≥)
            input.addEventListener('focus', function(e) {
                if (e.target.value === '0') {
                    e.target.value = '';
                }
            });
            
            // Khi blur (r·ªùi kh·ªèi input)
            input.addEventListener('blur', function(e) {
                if (e.target.value === '') {
                    e.target.value = '0';
                }
            });
        }

        // L·∫•y gi√° tr·ªã th·ª±c c·ªßa initialCost (kh√¥ng c√≥ d·∫•u ph·∫©y)
        function getInitialCostValue() {
            const input = document.getElementById('initialCost');
            return parseFloat(unformatNumber(input.value)) || 0;
        }

        // Set gi√° tr·ªã cho initialCost (t·ª± ƒë·ªông format)
        function setInitialCostValue(value) {
            const input = document.getElementById('initialCost');
            if (value > 0) {
                input.value = formatNumber(value.toString());
            } else {
                input.value = '0';
            }
        }

        // D·ªØ li·ªáu demo
        const demoData = {
            gridPrice: 2500,
            solarPrice: 0,
            vatRate: 8,
            initialCost: 150000000, // 150 tri·ªáu VNƒê
            monthlyData: [
                { load: 820.5, grid: 230, backup: 0.5, gridPrice: 2500 },      // Th√°ng 1
                { load: 795.8, grid: 220, backup: 0.4, gridPrice: 2500 },      // Th√°ng 2
                { load: 840.3, grid: 245, backup: 0.6, gridPrice: 2600 },      // Th√°ng 3 (gi√° tƒÉng)
                { load: 880.6, grid: 260, backup: 0.7, gridPrice: 2600 },      // Th√°ng 4
                { load: 920.4, grid: 275, backup: 0.8, gridPrice: 2700 },      // Th√°ng 5 (gi√° tƒÉng)
                { load: 910.2, grid: 270, backup: 0.7, gridPrice: 2700 },      // Th√°ng 6
                { load: 850.7, grid: 250, backup: 0.6, gridPrice: 2700 },      // Th√°ng 7
                { load: 815.3, grid: 235, backup: 0.5, gridPrice: 2600 },      // Th√°ng 8
                { load: 827.4, grid: 279.0, backup: 0.4, gridPrice: 2600 },    // Th√°ng 9
                { load: 710.0, grid: 225.0, backup: 0.3, gridPrice: 2500 },    // Th√°ng 10
                { load: 765.5, grid: 240.0, backup: 0.4, gridPrice: 2500 },    // Th√°ng 11
                { load: 795.0, grid: 255.0, backup: 0.5, gridPrice: 2500 }     // Th√°ng 12
            ]
        };

        // Kh·ªüi t·∫°o form nh·∫≠p li·ªáu - ƒê·ªông v·ªõi Ph√¢n trang
        function initializeInputs(keepCurrentData = false) {
            const container = document.getElementById('monthInputs');
            
            // L∆∞u d·ªØ li·ªáu hi·ªán t·∫°i tr∆∞·ªõc khi clear
            let savedData = {};
            if (keepCurrentData) {
                for (let i = 0; i < totalMonths; i++) {
                    const loadEl = document.getElementById(`load${i}`);
                    const gridEl = document.getElementById(`grid${i}`);
                    const backupEl = document.getElementById(`backup${i}`);
                    if (loadEl) savedData[i] = {
                        load: loadEl.value,
                        grid: gridEl.value,
                        backup: backupEl.value
                    };
                }
            }
            
            container.innerHTML = '';
            
            // T√≠nh to√°n trang
            const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            const startIndex = (currentPage - 1) * MONTHS_PER_PAGE;
            const endIndex = Math.min(startIndex + MONTHS_PER_PAGE, totalMonths);
            
            // Ch·ªâ hi·ªÉn th·ªã th√°ng trong trang hi·ªán t·∫°i
            for (let i = startIndex; i < endIndex; i++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-input';
                
                // L·∫•y gi√° tr·ªã ƒë√£ l∆∞u n·∫øu c√≥
                const savedValues = savedData[i] || { load: '0', grid: '0', backup: '0' };
                
                monthDiv.innerHTML = `
                    <h4>${getMonthName(i)}</h4>
                    <label>üîå Load (kWh)</label>
                    <input type="number" id="load${i}" value="${savedValues.load}" min="0" step="0.1" placeholder="0">
                    
                    <label>‚ö° Grid EVN (kWh)</label>
                    <input type="number" id="grid${i}" value="${savedValues.grid}" min="0" step="0.1" placeholder="0">
                    
                    <label>üîã Backup (kWh)</label>
                    <input type="number" id="backup${i}" value="${savedValues.backup}" min="0" step="0.1" placeholder="0">
                `;
                container.appendChild(monthDiv);
            }
            
            updateMonthCountInfo();
            updatePagination();
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin ph√¢n trang
        function updatePagination() {
            const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            const startMonth = (currentPage - 1) * MONTHS_PER_PAGE + 1;
            const endMonth = Math.min(currentPage * MONTHS_PER_PAGE, totalMonths);
            
            const pageText = `Trang ${currentPage}/${totalPages} (Th√°ng ${startMonth}-${endMonth}/${totalMonths})`;
            document.getElementById('pageInfo').textContent = pageText;
            document.getElementById('pageInfoBottom').textContent = pageText;
            
            // Update button states
            const prevButtons = document.querySelectorAll('.pagination button:first-child');
            const nextButtons = document.querySelectorAll('.pagination button:last-child');
            
            prevButtons.forEach(btn => btn.disabled = currentPage <= 1);
            nextButtons.forEach(btn => btn.disabled = currentPage >= totalPages);
            
            // ·∫®n pagination n·∫øu ch·ªâ c√≥ 1 trang
            const paginationEls = document.querySelectorAll('.pagination');
            paginationEls.forEach(el => {
                el.style.display = totalPages <= 1 ? 'none' : 'flex';
            });
        }
        
        // Trang tr∆∞·ªõc
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                initializeInputs(true);
                // Scroll to top
                document.getElementById('monthInputsContainer').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Trang sau
        function nextPage() {
            const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                initializeInputs(true);
                // Scroll to top
                document.getElementById('monthInputsContainer').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // C·∫≠p nh·∫≠t th√¥ng tin s·ªë th√°ng
        function updateMonthCountInfo() {
            const years = Math.floor(totalMonths / 12);
            const months = totalMonths % 12;
            let info = `üìÖ Hi·ªán c√≥ ${totalMonths} th√°ng`;
            if (years > 0) {
                info += ` (${years} nƒÉm ${months} th√°ng)`;
            }
            document.getElementById('monthCountInfo').textContent = info;
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            document.querySelector('.input-section h2 span').textContent = `üìä Nh·∫≠p D·ªØ Li·ªáu (${totalMonths} Th√°ng)`;
        }

        // Th√™m th√°ng m·ªõi
        function addMonth() {
            totalMonths++;
            
            // T·ª± ƒë·ªông fill demo data cho th√°ng m·ªõi (option)
            const newMonthIndex = totalMonths - 1;
            const monthInYear = newMonthIndex % 12;
            const yearIndex = Math.floor(newMonthIndex / 12);
            const variation = 1 + (yearIndex * 0.03); // TƒÉng 3% m·ªói nƒÉm
            
            // L·∫•y base data t·ª´ pattern
            if (demoData.monthlyData[monthInYear]) {
                const baseData = demoData.monthlyData[monthInYear];
                monthDataCache[`load${newMonthIndex}`] = (baseData.load * variation).toFixed(1);
                monthDataCache[`grid${newMonthIndex}`] = (baseData.grid * variation).toFixed(1);
                monthDataCache[`backup${newMonthIndex}`] = (baseData.backup * variation).toFixed(1);
                monthDataCache[`gridPrice${newMonthIndex}`] = (baseData.gridPrice + (yearIndex * 100)).toString();
            }
            
            // T·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn trang cu·ªëi n·∫øu th√™m th√°ng m·ªõi
            currentPage = Math.ceil(totalMonths / MONTHS_PER_PAGE);
            initializeInputs(true);
            showNotification(`‚ûï ƒê√£ th√™m ${getMonthName(newMonthIndex)}! ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn d·ªØ li·ªáu demo (c√≥ th·ªÉ ch·ªânh s·ª≠a)`, 'success');
        }

        // X√≥a th√°ng cu·ªëi
        function removeMonth() {
            if (totalMonths <= 1) {
                showNotification('‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a! Ph·∫£i c√≥ √≠t nh·∫•t 1 th√°ng.', 'error');
                return;
            }
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${getMonthName(totalMonths - 1)}?`)) {
                totalMonths--;
                // ƒêi·ªÅu ch·ªânh trang n·∫øu c·∫ßn
                const totalPages = Math.ceil(totalMonths / MONTHS_PER_PAGE);
                if (currentPage > totalPages) currentPage = totalPages;
                initializeInputs(true);
                showNotification(`‚ùå ƒê√£ x√≥a th√°ng cu·ªëi!`, 'info');
            }
        }

        // Toggle hi·ªÉn th·ªã/·∫©n ph·∫ßn nh·∫≠p d·ªØ li·ªáu
        function toggleMonthInputs() {
            const container = document.getElementById('monthInputsContainer');
            const btn = document.getElementById('toggleBtn');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                btn.textContent = 'üîΩ Hi·ªán';
            } else {
                container.classList.remove('collapsed');
                container.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }

        // Toggle hi·ªÉn th·ªã/·∫©n ph·∫ßn chi ti·∫øt th√°ng
        function toggleMonthDetails() {
            const container = document.getElementById('monthDetails');
            const btn = document.getElementById('toggleDetailsBtn');
            
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                btn.textContent = 'üîΩ Hi·ªán';
            } else {
                container.classList.remove('collapsed');
                container.classList.add('expanded');
                btn.textContent = 'üîº ·∫®n';
            }
        }

        // B·ªè h√†m scheduleAutoSave - kh√¥ng c√≤n c·∫ßn t·ª± ƒë·ªông l∆∞u khi thay ƒë·ªïi

        // T·∫°o d·ªØ li·ªáu demo t·ª± ƒë·ªông cho t·∫•t c·∫£ th√°ng
        function generateDemoDataForAllMonths() {
            const generatedData = [];
            
            // Base data pattern (12 th√°ng)
            const basePattern = demoData.monthlyData;
            
            // T·∫°o data cho t·∫•t c·∫£ th√°ng
            for (let i = 0; i < totalMonths; i++) {
                // L·∫∑p l·∫°i pattern 12 th√°ng
                const monthInYear = i % 12;
                const baseData = basePattern[monthInYear];
                
                // Th√™m variation nh·ªè ƒë·ªÉ data kh√¥ng gi·ªëng h·ªát nhau m·ªói nƒÉm
                const yearIndex = Math.floor(i / 12);
                const variation = 1 + (yearIndex * 0.03); // TƒÉng 3% m·ªói nƒÉm
                
                generatedData.push({
                    load: parseFloat((baseData.load * variation).toFixed(1)),
                    grid: parseFloat((baseData.grid * variation).toFixed(1)),
                    backup: parseFloat((baseData.backup * variation).toFixed(1))
                });
            }
            
            return generatedData;
        }
        
        // T·∫£i d·ªØ li·ªáu demo
        function loadDemoData() {
            // Set hidden values for backward compatibility
            document.getElementById('solarPrice').value = demoData.solarPrice;
            document.getElementById('vatRate').value = demoData.vatRate;
            
            // Set initial cost
            setInitialCostValue(demoData.initialCost);
            
            // Clear cache
            monthDataCache = {};

            // T·∫°o demo data cho t·∫•t c·∫£ th√°ng
            const allMonthsData = generateDemoDataForAllMonths();
            
            // Load data v√†o cache
            allMonthsData.forEach((data, index) => {
                monthDataCache[`load${index}`] = data.load.toString();
                monthDataCache[`grid${index}`] = data.grid.toString();
                monthDataCache[`backup${index}`] = data.backup.toString();
            });
            
            // Load v√†o inputs hi·ªÉn th·ªã (ch·ªâ trang hi·ªán t·∫°i)
            allMonthsData.forEach((data, index) => {
                const loadEl = document.getElementById(`load${index}`);
                const gridEl = document.getElementById(`grid${index}`);
                const backupEl = document.getElementById(`backup${index}`);
                
                if (loadEl) loadEl.value = data.load;
                if (gridEl) gridEl.value = data.grid;
                if (backupEl) backupEl.value = data.backup;
            });

            showNotification(`‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu demo cho T·∫§T C·∫¢ ${totalMonths} th√°ng (t·ª± ƒë·ªông tƒÉng 3%/nƒÉm)!`, 'success');
            calculateSavings();
        }

        // Helper: L·∫•y gi√° tr·ªã t·ª´ input, n·∫øu kh√¥ng t·ªìn t·∫°i th√¨ l·∫•y t·ª´ cache
        let monthDataCache = {}; // Cache ƒë·ªÉ l∆∞u d·ªØ li·ªáu c√°c th√°ng kh√¥ng hi·ªÉn th·ªã
        
        function getMonthValue(id, defaultValue = '0') {
            const el = document.getElementById(id);
            if (el) {
                // Update cache
                monthDataCache[id] = el.value;
                return el.value;
            }
            // Return from cache if exists
            return monthDataCache[id] || defaultValue;
        }
        
        // L∆∞u c√†i ƒë·∫∑t v√†o localStorage - Real-time
        function saveSettings(isAutoSave = false) {
            // C·∫≠p nh·∫≠t cache v·ªõi gi√° tr·ªã hi·ªán t·∫°i
            for (let i = 0; i < totalMonths; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
            }
            
            const settings = {
                solarPrice: document.getElementById('solarPrice').value,
                vatRate: document.getElementById('vatRate').value,
                initialCost: getInitialCostValue().toString(),
                totalMonths: totalMonths,
                startYear: startYear,
                currentPage: currentPage,
                monthlyData: [],
                savedAt: new Date().toISOString(),
                version: '3.2'
            };

            for (let i = 0; i < totalMonths; i++) {
                settings.monthlyData.push({
                    load: getMonthValue(`load${i}`, '0'),
                    grid: getMonthValue(`grid${i}`, '0'),
                    backup: getMonthValue(`backup${i}`, '0')
                });
            }

            try {
                localStorage.setItem('solarSettings', JSON.stringify(settings));
                updateStorageStatus();
                
                // Hi·ªÉn th·ªã indicator khi l∆∞u
                const indicator = document.getElementById('autoSaveIndicator');
                indicator.classList.add('active');
                indicator.textContent = 'üíæ ƒêang l∆∞u...';
                
                setTimeout(() => {
                    indicator.classList.remove('active');
                    indicator.textContent = 'üíæ ƒê√£ l∆∞u!';
                    setTimeout(() => {
                        indicator.textContent = 'üíæ L∆∞u t·ª± ƒë·ªông khi b·∫•m L∆∞u C√†i ƒê·∫∑t';
                    }, 2000);
                }, 500);
                
                if (!isAutoSave) {
                    showNotification('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
                }
            } catch (e) {
                showNotification('‚ùå L·ªói khi l∆∞u c√†i ƒë·∫∑t: ' + e.message, 'error');
            }
        }

        // Xu·∫•t c√†i ƒë·∫∑t ra file JSON
        function exportSettings() {
            // C·∫≠p nh·∫≠t cache tr∆∞·ªõc khi export
            for (let i = 0; i < totalMonths; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
            }
            
            const settings = {
                solarPrice: document.getElementById('solarPrice').value,
                vatRate: document.getElementById('vatRate').value,
                initialCost: getInitialCostValue().toString(),
                totalMonths: totalMonths,
                startYear: startYear,
                monthlyData: [],
                exportedAt: new Date().toISOString(),
                version: '3.2'
            };

            for (let i = 0; i < totalMonths; i++) {
                settings.monthlyData.push({
                    month: getMonthName(i),
                    load: getMonthValue(`load${i}`, '0'),
                    grid: getMonthValue(`grid${i}`, '0'),
                    backup: getMonthValue(`backup${i}`, '0')
                });
            }

            try {
                const dataStr = JSON.stringify(settings, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `solar-settings-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showNotification('üì§ ƒê√£ xu·∫•t file c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
            } catch (e) {
                showNotification('‚ùå L·ªói khi xu·∫•t file: ' + e.message, 'error');
            }
        }
        
        // T·∫£i c√†i ƒë·∫∑t t·ª´ localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('solarSettings');
            
            if (!savedSettings) {
                showNotification('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë√£ l∆∞u!', 'info');
                return;
            }

            try {
                const settings = JSON.parse(savedSettings);
                
                // C·∫≠p nh·∫≠t s·ªë th√°ng v√† nƒÉm n·∫øu c√≥
                if (settings.totalMonths) {
                    totalMonths = settings.totalMonths;
                }
                if (settings.startYear) {
                    startYear = settings.startYear;
                }
                if (settings.currentPage) {
                    currentPage = settings.currentPage;
                }
                
                // Clear cache v√† load l·∫°i
                monthDataCache = {};
                
                // Load data v√†o cache tr∆∞·ªõc
                settings.monthlyData.forEach((data, index) => {
                    monthDataCache[`load${index}`] = data.load;
                    monthDataCache[`grid${index}`] = data.grid;
                    monthDataCache[`backup${index}`] = data.backup;
                });
                
                // Kh·ªüi t·∫°o l·∫°i inputs v·ªõi s·ªë th√°ng m·ªõi
                initializeInputs();
                
                document.getElementById('solarPrice').value = settings.solarPrice || 0;
                document.getElementById('vatRate').value = settings.vatRate;
                setInitialCostValue(parseFloat(settings.initialCost) || 0);

                // Load data v√†o c√°c input hi·ªÉn th·ªã
                settings.monthlyData.forEach((data, index) => {
                    if (index < totalMonths) {
                        const loadEl = document.getElementById(`load${index}`);
                        const gridEl = document.getElementById(`grid${index}`);
                        const backupEl = document.getElementById(`backup${index}`);
                        
                        if (loadEl) loadEl.value = data.load;
                        if (gridEl) gridEl.value = data.grid;
                        if (backupEl) backupEl.value = data.backup;
                    }
                });

                showNotification('üìÇ ƒê√£ t·∫£i c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
                calculateSavings();
            } catch (e) {
                showNotification('‚ùå L·ªói khi t·∫£i c√†i ƒë·∫∑t: ' + e.message, 'error');
            }
        }

        // Nh·∫≠p c√†i ƒë·∫∑t t·ª´ file JSON
        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    // C·∫≠p nh·∫≠t s·ªë th√°ng v√† nƒÉm - QUAN TR·ªåNG!
                    if (settings.totalMonths) {
                        totalMonths = settings.totalMonths;
                    } else if (settings.monthlyData) {
                        // Fallback: N·∫øu kh√¥ng c√≥ totalMonths, d√πng length c·ªßa monthlyData
                        totalMonths = settings.monthlyData.length;
                    }
                    
                    if (settings.startYear) {
                        startYear = settings.startYear;
                    } else {
                        startYear = new Date().getFullYear();
                    }
                    
                    // Reset v·ªÅ trang 1
                    currentPage = 1;
                    
                    // Clear cache v√† load l·∫°i
                    monthDataCache = {};
                    
                    // Load data v√†o cache tr∆∞·ªõc
                    settings.monthlyData.forEach((data, index) => {
                        monthDataCache[`load${index}`] = data.load;
                        monthDataCache[`grid${index}`] = data.grid;
                        monthDataCache[`backup${index}`] = data.backup;
                    });
                    
                    // Kh·ªüi t·∫°o l·∫°i inputs v·ªõi s·ªë th√°ng m·ªõi
                    initializeInputs();
                    
                    document.getElementById('solarPrice').value = settings.solarPrice || 0;
                    document.getElementById('vatRate').value = settings.vatRate || 8;
                    setInitialCostValue(parseFloat(settings.initialCost) || 0);

                    // Load data v√†o c√°c input hi·ªÉn th·ªã
                    settings.monthlyData.forEach((data, index) => {
                        if (index < totalMonths) {
                            const loadEl = document.getElementById(`load${index}`);
                            const gridEl = document.getElementById(`grid${index}`);
                            const backupEl = document.getElementById(`backup${index}`);
                            
                            if (loadEl) loadEl.value = data.load;
                            if (gridEl) gridEl.value = data.grid;
                            if (backupEl) backupEl.value = data.backup;
                        }
                    });

                    showNotification('üì• ƒê√£ nh·∫≠p file c√†i ƒë·∫∑t th√†nh c√¥ng!', 'success');
                    calculateSavings();
                    saveSettings(true);
                } catch (e) {
                    showNotification('‚ùå L·ªói khi ƒë·ªçc file: ' + e.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i l∆∞u tr·ªØ
        function updateStorageStatus() {
            const savedSettings = localStorage.getItem('solarSettings');
            const statusEl = document.getElementById('storageStatus');
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    const savedDate = new Date(settings.savedAt);
                    const formattedDate = savedDate.toLocaleString('vi-VN');
                    statusEl.textContent = `ƒê√£ l∆∞u l·∫ßn cu·ªëi: ${formattedDate}`;
                } catch (e) {
                    statusEl.textContent = 'C√≥ d·ªØ li·ªáu ƒë√£ l∆∞u';
                }
            } else {
                statusEl.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu l∆∞u tr·ªØ';
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // T√≠nh gi√° ƒëi·ªán theo b·∫≠c thang EVN m·ªõi (bao g·ªìm VAT 8%)
        function calculateTieredPrice(kWh, vatRate) {
            if (kWh <= 0) return 0;
            
            let totalCost = 0;
            let remaining = kWh;
            
            // B·∫≠c 1: 0 - 50 kWh = 1,984 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier1 = Math.min(remaining, 50);
                totalCost += tier1 * 1984;
                remaining -= tier1;
            }
            
            // B·∫≠c 2: 51 - 100 kWh = 2,050 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier2 = Math.min(remaining, 50); // 50 kWh trong b·∫≠c n√†y
                totalCost += tier2 * 2050;
                remaining -= tier2;
            }
            
            // B·∫≠c 3: 101 - 200 kWh = 2,380 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier3 = Math.min(remaining, 100); // 100 kWh trong b·∫≠c n√†y
                totalCost += tier3 * 2380;
                remaining -= tier3;
            }
            
            // B·∫≠c 4: 201 - 300 kWh = 2,998 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier4 = Math.min(remaining, 100); // 100 kWh trong b·∫≠c n√†y
                totalCost += tier4 * 2998;
                remaining -= tier4;
            }
            
            // B·∫≠c 5: 301 - 400 kWh = 3,350 ƒë·ªìng/kWh
            if (remaining > 0) {
                const tier5 = Math.min(remaining, 100); // 100 kWh trong b·∫≠c n√†y
                totalCost += tier5 * 3350;
                remaining -= tier5;
            }
            
            // B·∫≠c 6: 401+ kWh = 3,460 ƒë·ªìng/kWh
            if (remaining > 0) {
                totalCost += remaining * 3460;
            }
            
            // √Åp d·ª•ng VAT
            return totalCost * (1 + vatRate);
        }

        // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn VND
        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // ƒê·ªãnh d·∫°ng s·ªë kWh
        function formatKWh(value) {
            return new Intl.NumberFormat('vi-VN', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value) + ' kWh';
        }

        // T√≠nh to√°n ti·∫øt ki·ªám
        function calculateSavings() {
            const solarPrice = parseFloat(document.getElementById('solarPrice').value);
            const vatRate = parseFloat(document.getElementById('vatRate').value) / 100;

            let totalSavings = 0;
            let totalLoad = 0;
            let totalSolarProduced = 0;
            let totalGrid = 0;
            let totalCostWithoutSolar = 0;
            let monthsWithData = 0; // ƒê·∫øm s·ªë th√°ng c√≥ d·ªØ li·ªáu
            const savingsData = [];
            const monthlyDetails = [];

            // C·∫≠p nh·∫≠t cache tr∆∞·ªõc khi t√≠nh to√°n
            for (let i = 0; i < totalMonths; i++) {
                const loadEl = document.getElementById(`load${i}`);
                const gridEl = document.getElementById(`grid${i}`);
                const backupEl = document.getElementById(`backup${i}`);
                
                if (loadEl) monthDataCache[`load${i}`] = loadEl.value;
                if (gridEl) monthDataCache[`grid${i}`] = gridEl.value;
                if (backupEl) monthDataCache[`backup${i}`] = backupEl.value;
            }
            
            for (let i = 0; i < totalMonths; i++) {
                const load = parseFloat(getMonthValue(`load${i}`, '0')) || 0;
                const grid = parseFloat(getMonthValue(`grid${i}`, '0')) || 0;
                const backup = parseFloat(getMonthValue(`backup${i}`, '0')) || 0;

                // ƒê·∫øm th√°ng c√≥ d·ªØ li·ªáu (n·∫øu c√≥ √≠t nh·∫•t 1 gi√° tr·ªã > 0)
                if (load > 0 || grid > 0 || backup > 0) {
                    monthsWithData++;
                }

                // ƒêi·ªán m·∫∑t tr·ªùi s·∫£n xu·∫•t = Load + Backup - Grid
                const solarProduced = load + backup - grid;
                
                // Chi ph√≠ l∆∞·ªõi ƒëi·ªán EVN (Grid) - D√ôNG B·∫¨C THANG
                const gridCost = calculateTieredPrice(grid, vatRate);
                
                // Chi ph√≠ n·∫øu ph·∫£i mua ph·∫ßn Solar t·ª´ EVN (thay v√¨ t·ª± s·∫£n xu·∫•t) - D√ôNG B·∫¨C THANG
                const costWithoutSolar = calculateTieredPrice(solarProduced, vatRate);
                
                // Chi ph√≠ ƒëi·ªán m·∫∑t tr·ªùi (hi·ªán t·∫°i = 0 v√¨ t·ª± s·∫£n xu·∫•t)
                const solarCost = solarProduced * solarPrice;
                
                // Chi ph√≠ th·ª±c t·∫ø = Chi ph√≠ l∆∞·ªõi ƒëi·ªán + Chi ph√≠ m·∫∑t tr·ªùi
                const actualCost = gridCost + solarCost;
                
                // Ti·∫øt ki·ªám = Chi ph√≠ n·∫øu mua Solar t·ª´ EVN - Chi ph√≠ Solar th·ª±c t·∫ø
                const savings = costWithoutSolar - solarCost;

                totalSavings += savings;
                totalLoad += load;
                totalSolarProduced += solarProduced;
                totalGrid += grid;
                totalCostWithoutSolar += costWithoutSolar;
                savingsData.push(savings);

                monthlyDetails.push({
                    month: getMonthName(i),
                    load: load,
                    grid: grid,
                    backup: backup,
                    solarProduced: solarProduced,
                    gridCost: gridCost,
                    costWithoutSolar: costWithoutSolar,
                    solarCost: solarCost,
                    actualCost: actualCost,
                    savings: savings
                });
            }

            // T√≠nh trung b√¨nh d·ª±a tr√™n s·ªë th√°ng c√≥ d·ªØ li·ªáu
            const avgSavings = monthsWithData > 0 ? totalSavings / monthsWithData : 0;
            const avgLoad = monthsWithData > 0 ? totalLoad / monthsWithData : 0;
            const avgSolar = monthsWithData > 0 ? totalSolarProduced / monthsWithData : 0;
            const avgGrid = monthsWithData > 0 ? totalGrid / monthsWithData : 0;
            const avgCostWithoutSolar = monthsWithData > 0 ? totalCostWithoutSolar / monthsWithData : 0;

            // C·∫≠p nh·∫≠t t·ªïng k·∫øt
            document.getElementById('totalSavings').textContent = formatVND(totalSavings);
            document.getElementById('totalLoad').textContent = formatKWh(totalLoad);
            document.getElementById('totalSolar').textContent = formatKWh(totalSolarProduced);
            document.getElementById('totalGrid').textContent = formatKWh(totalGrid);
            document.getElementById('totalCostWithoutSolar').textContent = formatVND(totalCostWithoutSolar);
            document.getElementById('avgSavings').textContent = formatVND(avgSavings);
            
            // C·∫≠p nh·∫≠t trung b√¨nh m·ªõi
            document.getElementById('avgLoad').textContent = formatKWh(avgLoad);
            document.getElementById('avgSolar').textContent = formatKWh(avgSolar);
            document.getElementById('avgGrid').textContent = formatKWh(avgGrid);
            document.getElementById('avgCostWithoutSolar').textContent = formatVND(avgCostWithoutSolar);

            // T√≠nh to√°n ROI - truy·ªÅn th√™m monthsWithData
            calculateROI(totalSavings, monthsWithData);

            // V·∫Ω bi·ªÉu ƒë·ªì
            drawChart(savingsData);

            // Hi·ªÉn th·ªã chi ti·∫øt
            displayDetails(monthlyDetails);
        }

        // T√≠nh to√°n ROI (Return on Investment)
        // C√¥ng th·ª©c c∆° b·∫£n:
        // - Ti·∫øt ki·ªám TB/th√°ng = T·ªïng ti·∫øt ki·ªám / S·ªë th√°ng c√≥ d·ªØ li·ªáu
        // - Th·ªùi gian ho√†n v·ªën (th√°ng) = Chi ph√≠ l·∫Øp ƒë·∫∑t / Ti·∫øt ki·ªám TB/th√°ng
        // - C√≤n ph·∫£i thu h·ªìi = Chi ph√≠ - ƒê√£ ti·∫øt ki·ªám
        // - % Ho√†n v·ªën = (ƒê√£ ti·∫øt ki·ªám / Chi ph√≠) √ó 100
        //
        // M·ªü r·ªông cho nhi·ªÅu nƒÉm:
        // - N·∫øu c√≥ 24 th√°ng data (2 nƒÉm): monthsWithData = 24
        // - N·∫øu c√≥ 36 th√°ng data (3 nƒÉm): monthsWithData = 36
        // - C√¥ng th·ª©c v·∫´n gi·ªØ nguy√™n, ch·ªâ thay ƒë·ªïi monthsWithData
        function calculateROI(totalSavings, monthsWithData) {
            const initialCost = getInitialCostValue();
            
            if (initialCost <= 0) {
                document.getElementById('roiSection').style.display = 'none';
                return;
            }

            // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu th√°ng n√†o, ·∫©n ROI
            if (monthsWithData <= 0) {
                document.getElementById('roiSection').style.display = 'none';
                return;
            }

            document.getElementById('roiSection').style.display = 'block';

            // S·ªë ti·ªÅn ƒë√£ ti·∫øt ki·ªám (d·ª±a tr√™n s·ªë th√°ng c√≥ data)
            const savedAmount = totalSavings;
            
            // S·ªë ti·ªÅn c√≤n ph·∫£i thu h·ªìi
            const remainingAmount = initialCost - savedAmount;
            
            // Ti·∫øt ki·ªám TB/th√°ng - CH·ªà T√çNH TR√äN S·ªê TH√ÅNG C√ì D·ªÆA LI·ªÜU
            const avgMonthlySavings = totalSavings / monthsWithData;
            
            // Th·ªùi gian ho√†n v·ªën (th√°ng)
            let paybackMonths = 0;
            let paybackNote = '';
            
            if (avgMonthlySavings > 0) {
                paybackMonths = initialCost / avgMonthlySavings;
                const years = Math.floor(paybackMonths / 12);
                const months = Math.round(paybackMonths % 12);
                
                if (years > 0) {
                    paybackNote = `(${years} nƒÉm ${months} th√°ng)`;
                } else {
                    paybackNote = '';
                }
            }
            
            // Ph·∫ßn trƒÉm ho√†n v·ªën
            const percentRecovered = Math.min((savedAmount / initialCost) * 100, 100);
            
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            document.getElementById('roiInitialCost').textContent = formatVND(initialCost);
            document.getElementById('roiSaved').textContent = formatVND(savedAmount);
            
            // Hi·ªÉn th·ªã s·ªë th√°ng ƒë√£ c√≥ data
            const yearsData = Math.floor(monthsWithData / 12);
            const monthsData = monthsWithData % 12;
            let dataNote = '';
            if (yearsData > 0) {
                dataNote = `(${yearsData} nƒÉm ${monthsData} th√°ng data)`;
            } else {
                dataNote = `(${monthsData} th√°ng data)`;
            }
            document.getElementById('roiSavedNote').textContent = dataNote;
            
            if (remainingAmount > 0) {
                document.getElementById('roiRemaining').textContent = formatVND(remainingAmount);
                const monthsNeeded = Math.ceil(remainingAmount / avgMonthlySavings);
                const yearsNeeded = (monthsNeeded / 12).toFixed(1);
                if (monthsNeeded > 12) {
                    document.getElementById('roiRemainingNote').textContent = `C·∫ßn th√™m ~${yearsNeeded} nƒÉm (${monthsNeeded} th√°ng)`;
                } else {
                    document.getElementById('roiRemainingNote').textContent = `C·∫ßn th√™m ${monthsNeeded} th√°ng`;
                }
                document.getElementById('roiRemainingNote').style.color = '#fbbf24';
                
                // ·∫®n card ti·ªÅn l·ªùi
                document.getElementById('roiProfitCard').style.display = 'none';
            } else {
                document.getElementById('roiRemaining').textContent = '0 ‚Ç´';
                document.getElementById('roiRemainingNote').textContent = '‚úÖ ƒê√£ ho√†n v·ªën!';
                document.getElementById('roiRemainingNote').style.color = '#4ade80';
                
                // Hi·ªÉn th·ªã ti·ªÅn l·ªùi
                const profit = savedAmount - initialCost;
                document.getElementById('roiProfit').textContent = formatVND(profit);
                
                // T√≠nh th·ªùi gian ƒë√£ c√≥ l·ªùi
                const profitMonths = Math.floor(profit / avgMonthlySavings);
                const profitYears = (profitMonths / 12).toFixed(1);
                if (profitMonths > 12) {
                    document.getElementById('roiProfitNote').textContent = `L·ªùi sau ${profitYears} nƒÉm ho√†n v·ªën`;
                } else {
                    document.getElementById('roiProfitNote').textContent = `L·ªùi sau ${profitMonths} th√°ng ho√†n v·ªën`;
                }
                document.getElementById('roiProfitNote').style.color = '#10b981';
                
                // Hi·ªÉn card ti·ªÅn l·ªùi
                document.getElementById('roiProfitCard').style.display = 'block';
            }
            
            if (paybackMonths > 0) {
                if (paybackMonths <= 12) {
                    document.getElementById('roiTime').textContent = `${Math.round(paybackMonths)} th√°ng`;
                    document.getElementById('roiTimeNote').textContent = '';
                } else {
                    const years = (paybackMonths / 12).toFixed(1);
                    const totalMonths = Math.round(paybackMonths);
                    document.getElementById('roiTime').textContent = `${years} nƒÉm`;
                    document.getElementById('roiTimeNote').textContent = `(${totalMonths} th√°ng)`;
                }
            } else {
                document.getElementById('roiTime').textContent = '‚àû';
                document.getElementById('roiTimeNote').textContent = 'Kh√¥ng ti·∫øt ki·ªám';
            }
            
            // C·∫≠p nh·∫≠t thanh progress
            const progressFill = document.getElementById('roiProgressFill');
            const progressText = document.getElementById('roiProgressText');
            const percentText = `${percentRecovered.toFixed(1)}%`;
            
            progressFill.style.width = `${percentRecovered}%`;
            progressText.textContent = percentText;
            
            // ƒê·ªïi m√†u thanh progress d·ª±a tr√™n %
            if (percentRecovered >= 100) {
                progressFill.style.background = 'linear-gradient(90deg, #10b981, #34d399, #6ee7b7)';
            } else if (percentRecovered >= 75) {
                progressFill.style.background = 'linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd)';
            } else if (percentRecovered >= 50) {
                progressFill.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24, #fcd34d)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #ef4444, #f87171, #fca5a5)';
            }
        }

        // V·∫Ω bi·ªÉu ƒë·ªì
        function drawChart(data) {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: getMonthNames(),
                    datasets: [{
                        label: 'Ti·ªÅn ƒëi·ªán ti·∫øt ki·ªám (VNƒê)',
                        data: data,
                        backgroundColor: 'rgba(74, 222, 128, 0.8)',
                        borderColor: 'rgba(74, 222, 128, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#4ade80',
                            bodyColor: '#fff',
                            borderColor: '#4ade80',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Ti·∫øt ki·ªám: ' + formatVND(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#cbd5e0',
                                callback: function(value) {
                                    return formatVND(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cbd5e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Hi·ªÉn th·ªã chi ti·∫øt - V·ªõi ph√¢n trang, m·ªói h√†ng 6 th√°ng
        function displayDetails(details) {
            // L∆∞u t·∫•t c·∫£ chi ti·∫øt
            allMonthlyDetails = details;
            
            // C·∫≠p nh·∫≠t info
            document.getElementById('detailsMonthCountInfo').textContent = `üìÖ Hi·ªán c√≥ ${details.length} th√°ng`;
            
            // Hi·ªÉn th·ªã trang hi·ªán t·∫°i
            displayDetailsPage(currentDetailsPage);
        }
        
        // Hi·ªÉn th·ªã m·ªôt trang chi ti·∫øt
        function displayDetailsPage(page) {
            const container = document.getElementById('monthDetails');
            container.innerHTML = '';
            
            // T√≠nh to√°n ph·∫°m vi
            const totalPages = Math.ceil(allMonthlyDetails.length / DETAILS_MONTHS_PER_PAGE);
            currentDetailsPage = Math.max(1, Math.min(page, totalPages));
            
            const startIndex = (currentDetailsPage - 1) * DETAILS_MONTHS_PER_PAGE;
            const endIndex = Math.min(startIndex + DETAILS_MONTHS_PER_PAGE, allMonthlyDetails.length);
            const pageDetails = allMonthlyDetails.slice(startIndex, endIndex);

            // T·∫°o container cho c√°c h√†ng
            const rowsContainer = document.createElement('div');
            rowsContainer.className = 'details-rows-container';

            // Chia th√†nh c√°c h√†ng, m·ªói h√†ng 6 th√°ng
            const MONTHS_PER_ROW = 6;
            const totalRows = Math.ceil(pageDetails.length / MONTHS_PER_ROW);

            for (let rowIndex = 0; rowIndex < totalRows; rowIndex++) {
                const rowStartIndex = rowIndex * MONTHS_PER_ROW;
                const rowEndIndex = Math.min(rowStartIndex + MONTHS_PER_ROW, pageDetails.length);
                const rowMonths = pageDetails.slice(rowStartIndex, rowEndIndex);

                // T·∫°o h√†ng
                const row = document.createElement('div');
                row.className = 'details-row';
                
                rowMonths.forEach(detail => {
                    row.appendChild(createDetailCard(detail));
                });
                
                rowsContainer.appendChild(row);
            }

            container.appendChild(rowsContainer);
            
            // C·∫≠p nh·∫≠t pagination UI
            updateDetailsPagination();
        }
        
        // C·∫≠p nh·∫≠t UI pagination cho chi ti·∫øt
        function updateDetailsPagination() {
            const totalPages = Math.ceil(allMonthlyDetails.length / DETAILS_MONTHS_PER_PAGE);
            const pageInfo = `Trang ${currentDetailsPage}/${totalPages} (Th√°ng ${(currentDetailsPage-1)*DETAILS_MONTHS_PER_PAGE+1}-${Math.min(currentDetailsPage*DETAILS_MONTHS_PER_PAGE, allMonthlyDetails.length)})`;
            
            document.getElementById('detailsPageInfo').textContent = pageInfo;
            document.getElementById('detailsPageInfoBottom').textContent = pageInfo;
            
            // Disable/enable buttons
            const prevButtons = document.querySelectorAll('#detailsPaginationTop button:first-child, #detailsPaginationBottom button:first-child');
            const nextButtons = document.querySelectorAll('#detailsPaginationTop button:last-child, #detailsPaginationBottom button:last-child');
            
            prevButtons.forEach(btn => btn.disabled = currentDetailsPage === 1);
            nextButtons.forEach(btn => btn.disabled = currentDetailsPage === totalPages);
        }
        
        // Chuy·ªÉn trang chi ti·∫øt
        function nextDetailsPage() {
            const totalPages = Math.ceil(allMonthlyDetails.length / DETAILS_MONTHS_PER_PAGE);
            if (currentDetailsPage < totalPages) {
                displayDetailsPage(currentDetailsPage + 1);
            }
        }
        
        function previousDetailsPage() {
            if (currentDetailsPage > 1) {
                displayDetailsPage(currentDetailsPage - 1);
            }
        }

        // T·∫°o card chi ti·∫øt cho m·ªôt th√°ng - Compact version
        function createDetailCard(detail) {
            const card = document.createElement('div');
            card.className = 'detail-card';
            card.innerHTML = `
                <h4>${detail.month}</h4>
                
                <div class="detail-row-item">
                    <span class="label">Load:</span>
                    <span class="value">${formatKWh(detail.load)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Grid:</span>
                    <span class="value">${formatKWh(detail.grid)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Backup:</span>
                    <span class="value">${formatKWh(detail.backup)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">M·∫∑t tr·ªùi:</span>
                    <span class="value">${formatKWh(detail.solarProduced)}</span>
                </div>
                
                <div class="detail-row-item section-header">
                    <span>üí∞ Chi Ph√≠</span>
                    <span></span>
                </div>
                
                <div class="detail-row-item grid-cost">
                    <span class="label">EVN:</span>
                    <span class="value">${formatVND(detail.gridCost)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Solar:</span>
                    <span class="value">${formatVND(detail.solarCost)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Th·ª±c t·∫ø:</span>
                    <span class="value">${formatVND(detail.actualCost)}</span>
                </div>
                <div class="detail-row-item">
                    <span class="label">Kh√¥ng solar:</span>
                    <span class="value">${formatVND(detail.costWithoutSolar)}</span>
                </div>
                
                <div class="detail-row-item highlight">
                    <span>üî• Ti·∫øt ki·ªám:</span>
                    <span>${formatVND(detail.savings)}</span>
                </div>
            `;
            return card;
        }

        // ƒê·∫∑t l·∫°i d·ªØ li·ªáu
        function resetData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) {
                for (let i = 0; i < 12; i++) {
                    document.getElementById(`load${i}`).value = 0;
                    document.getElementById(`grid${i}`).value = 0;
                    document.getElementById(`backup${i}`).value = 0;
                }
                
                document.getElementById('totalSavings').textContent = '0 ‚Ç´';
                document.getElementById('totalLoad').textContent = '0 kWh';
                document.getElementById('totalSolar').textContent = '0 kWh';
                document.getElementById('totalGrid').textContent = '0 kWh';
                document.getElementById('totalCostWithoutSolar').textContent = '0 ‚Ç´';
                document.getElementById('avgSavings').textContent = '0 ‚Ç´';
                document.getElementById('avgLoad').textContent = '0 kWh';
                document.getElementById('avgSolar').textContent = '0 kWh';
                document.getElementById('avgGrid').textContent = '0 kWh';
                document.getElementById('avgCostWithoutSolar').textContent = '0 ‚Ç´';
                document.getElementById('monthDetails').innerHTML = '';
                
                if (chart) {
                    chart.destroy();
                    chart = null;
                }

                showNotification('üîÑ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!', 'info');
            }
        }

        // B·ªè h√†m setupPriceListeners - kh√¥ng c√≤n c·∫ßn

        // Kh·ªüi t·∫°o khi trang load
        window.onload = function() {
            initializeInputs();
            updateStorageStatus();
            setupInitialCostInput(); // Setup auto-format cho initialCost
            
            // T·ª± ƒë·ªông t·∫£i c√†i ƒë·∫∑t n·∫øu c√≥
            const savedSettings = localStorage.getItem('solarSettings');
            if (savedSettings) {
                loadSettings();
            } else {
                // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu l∆∞u, t·∫£i demo
                loadDemoData();
            }
        };
    </script>
</body>
</html>
